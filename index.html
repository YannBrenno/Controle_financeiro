<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle Financeiro Pessoal</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --card:#0b1220;
      --accent:#3b82f6; --text:#e5e7eb; --muted:#9ca3af;
      --danger:#ef4444; --ring:rgba(59,130,246,.35);
      --overlay:rgba(2,6,23,.6); --shadow:rgba(15,23,42,.45);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        var(--bg);
      color:var(--text);
      font:500 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    .app{max-width:1100px;margin:40px auto 80px;padding:0 20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
    .title{display:flex;align-items:center;gap:12px}
    .title .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#8b5cf6);display:grid;place-items:center;color:white;box-shadow:0 10px 25px rgba(99,102,241,.35)}
    .title h1{font-size:22px;margin:0;letter-spacing:.3px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    button{appearance:none;border:0;padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,#1f2937,#111827);color:var(--text);cursor:pointer;box-shadow:0 6px 20px rgba(2,6,23,.4),inset 0 0 0 1px rgba(255,255,255,.04);transition:transform .15s ease,box-shadow .2s ease,background .2s ease}
    button:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(2,6,23,.55),inset 0 0 0 1px rgba(255,255,255,.06)}
    .btn-accent{background:linear-gradient(180deg,#2563eb,#1d4ed8)}
    .btn-ghost{background:transparent;border:1px solid rgba(148,163,184,.2)}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media(max-width:1024px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:560px){.grid{grid-template-columns:1fr}header{flex-direction:column;align-items:stretch}.toolbar{justify-content:space-between}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01)),linear-gradient(180deg,#0b1220,#0a0f1a);border-radius:var(--radius);padding:18px;border:1px solid rgba(148,163,184,.16);min-height:126px;box-shadow:0 10px 30px var(--shadow);transition:transform .18s,border-color .18s}
    .card:hover{transform:translateY(-2px);border-color:rgba(59,130,246,.45)}
    .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .card-title{display:flex;align-items:center;gap:10px;color:#d1d5db}
    .card-title svg{width:20px;height:20px}
    .card-value{font-size:24px;font-weight:700}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .totals{margin-top:20px;background:linear-gradient(180deg,rgba(34,197,94,.08),rgba(34,197,94,.04));border:1px solid rgba(34,197,94,.25);color:#d1fae5;border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;color:var(--muted);font-size:12px}
    .kpi span{background:rgba(148,163,184,.1);border:1px solid rgba(148,163,184,.15);padding:6px 8px;border-radius:10px}
    .section-title{margin:22px 2px 8px;color:#cbd5e1;font-size:16px}
    .forecast .card{border-color:rgba(99,102,241,.25);cursor:default}
    .forecast .card:hover{transform:none;box-shadow:0 12px 28px rgba(99,102,241,.18);border-color:rgba(99,102,241,.45)}
    .forecast .card-value.small{font-size:20px}
    /* Modais */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:40}
    .modal.show{display:flex}
    .overlay{position:absolute;inset:0;background:var(--overlay)}
    .dialog{position:relative;z-index:1;width:min(820px,calc(100% - 28px));background:linear-gradient(180deg,#0c1425,#0a0f1a);border:1px solid rgba(148,163,184,.16);border-radius:16px;box-shadow:0 30px 80px rgba(2,6,23,.65)}
    .dialog header{padding:16px 18px;border-bottom:1px solid rgba(148,163,184,.12);display:flex;align-items:center;gap:8px}
    .dialog .content{padding:16px 18px;max-height:calc(80vh - 120px);overflow:auto}
    .dialog footer{padding:14px 18px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid rgba(148,163,184,.12)}
    .row{display:grid;grid-template-columns:1fr 180px 40px;gap:10px;align-items:center}
    .row.debt{grid-template-columns:1fr 140px 120px 160px 40px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="text"],input[type="number"],input[type="month"]{width:100%;background:#0b1220;color:var(--text);border:1px solid rgba(148,163,184,.16);border-radius:10px;padding:10px 12px;outline:none;transition:border-color .2s,box-shadow .2s,background .2s}
    .add-btn{margin-top:10px;background:linear-gradient(180deg,#16a34a,#15803d);color:#e5e7eb;border:0;padding:10px 14px;border-radius:10px}
    .remove-btn{background:linear-gradient(180deg,#1f2937,#0f172a);border:1px solid rgba(148,163,184,.2);color:#fca5a5;display:grid;place-items:center;padding:0;height:40px;width:40px;border-radius:10px}
    .close-x{background:transparent;border:0;color:var(--muted);margin-left:auto;font-size:20px;line-height:1;padding:4px 8px;cursor:pointer}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 7a2 2 0 0 1 2-2h10.5a2 2 0 0 1 1.79 1.106L20.118 10H21a2 2 0 1 1 0 4h-.882l-2.828 3.894A2 2 0 0 1 15.5 19H5a2 2 0 0 1-2-2V7z" stroke="white" stroke-opacity=".9" stroke-width="1.3"/><path d="M7 12h5" stroke="white" stroke-opacity=".9" stroke-width="1.3" stroke-linecap="round"/></svg>
        </div>
        <h1>Controle Financeiro Pessoal</h1>
      </div>
      <div class="toolbar">
        <button id="btn-export" class="btn btn-accent" type="button" title="Exportar JSON">Exportar JSON</button>
        <input id="file-input" class="sr-only" type="file" accept="application/json" />
        <button id="btn-import" class="btn btn-ghost" type="button" title="Importar JSON">Importar JSON</button>
      </div>
    </header>

    <section class="grid" aria-label="Cards de valores">
      <article class="card" id="card-salario" role="button" tabindex="0" aria-haspopup="dialog" aria-controls="modal-salario">
        <div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7Z" stroke="#60a5fa" stroke-width="1.5"/><path d="M7 9h10M7 12h6" stroke="#93c5fd" stroke-width="1.4" stroke-linecap="round"/></svg><span>Salário</span></div></div>
        <div class="card-value" id="val-salario">R$ 0,00</div>
        <div class="hint">Clique para editar</div>
      </article>

      <article class="card" id="card-descontos" role="button" tabindex="0" aria-haspopup="dialog" aria-controls="modal-descontos">
        <div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3.5 7.5a2 2 0 0 1 2-2H10l2 2h6.5a2 2 0 0 1 2 2V17a2 2 0 0 1-2 2H5.5a2 2 0 0 1-2-2v-9.5Z" stroke="#f59e0b" stroke-width="1.5"/><path d="M8 14.5 16 9.5" stroke="#fbbf24" stroke-width="1.4" stroke-linecap="round"/></svg><span>Descontos</span></div></div>
        <div class="card-value" id="val-descontos">R$ 0,00</div>
        <div class="hint">Soma de todos os descontos</div>
      </article>

      <article class="card" id="card-despesas" role="button" tabindex="0" aria-haspopup="dialog" aria-controls="modal-despesas">
        <div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 10a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-7Z" stroke="#22c55e" stroke-width="1.5"/><path d="M7 10V7a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v3" stroke="#86efac" stroke-width="1.4" stroke-linecap="round"/></svg><span>Despesas Fixas</span></div></div>
        <div class="card-value" id="val-despesas">R$ 0,00</div>
        <div class="hint">Soma das despesas fixas</div>
      </article>

      <article class="card" id="card-dividas" role="button" tabindex="0" aria-haspopup="dialog" aria-controls="modal-dividas">
        <div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="3" y="6" width="18" height="12" rx="2" stroke="#ef4444" stroke-width="1.5"/><path d="M3 10h18" stroke="#f87171" stroke-width="1.4" stroke-linecap="round"/></svg><span>Dívidas</span></div></div>
        <div class="card-value" id="val-dividas">R$ 0,00</div>
        <div class="hint">Total das dívidas</div>
      </article>
    </section>

    <section class="totals" aria-live="polite">
      <div>
        <strong id="saldo-final">Saldo Final: R$ 0,00</strong>
        <div class="kpi">
          <span id="kpi-sal">Salário: R$ 0,00</span>
          <span id="kpi-desc">Descontos: R$ 0,00</span>
          <span id="kpi-desp">Despesas: R$ 0,00</span>
          <span id="kpi-div">Dívidas: R$ 0,00</span>
        </div>
      </div>
      <div class="muted">Saldo Final = Salário - (Descontos + Despesas Fixas + Dívidas)</div>
    </section>

    <h3 class="section-title">Previsões dos próximos 12 meses</h3>
    <section class="grid forecast" aria-label="Cards de previsão"></section>
  </div>

  <!-- Modal: Salário -->
  <div class="modal" id="modal-salario" role="dialog" aria-modal="true" aria-labelledby="ttl-salario">
    <div class="overlay" data-close="modal"></div>
    <div class="dialog">
      <header>
        <h3 id="ttl-salario">Editar Salário</h3>
        <button class="close-x" type="button" data-close="modal" aria-label="Fechar">✕</button>
      </header>
      <div class="content">
        <div class="control">
          <label for="inp-salario">Valor do salário (R$)</label>
          <input id="inp-salario" type="text" inputmode="decimal" placeholder="0,00" />
        </div>
        <p class="muted">Aceita vírgula como separador decimal.</p>
      </div>
      <footer>
        <button class="btn-ghost" type="button" data-close="modal">Cancelar</button>
        <button class="btn btn-accent" id="save-salario" type="button">Salvar</button>
      </footer>
    </div>
  </div>

  <!-- Modal: Descontos -->
  <div class="modal" id="modal-descontos" role="dialog" aria-modal="true" aria-labelledby="ttl-descontos">
    <div class="overlay" data-close="modal"></div>
    <div class="dialog">
      <header>
        <h3 id="ttl-descontos">Descontos</h3>
        <button class="close-x" type="button" data-close="modal" aria-label="Fechar">✕</button>
      </header>
      <div class="content">
        <div id="list-descontos"></div>
        <button class="add-btn" id="add-desconto" type="button">+ Adicionar desconto</button>
      </div>
      <footer>
        <button class="btn-ghost" type="button" data-close="modal">Cancelar</button>
        <button class="btn btn-accent" id="save-descontos" type="button">Salvar</button>
      </footer>
    </div>
  </div>

  <!-- Modal: Despesas Fixas -->
  <div class="modal" id="modal-despesas" role="dialog" aria-modal="true" aria-labelledby="ttl-despesas">
    <div class="overlay" data-close="modal"></div>
    <div class="dialog">
      <header>
        <h3 id="ttl-despesas">Despesas Fixas</h3>
        <button class="close-x" type="button" data-close="modal" aria-label="Fechar">✕</button>
      </header>
      <div class="content">
        <div id="list-despesas"></div>
        <button class="add-btn" id="add-despesa" type="button">+ Adicionar despesa</button>
      </div>
      <footer>
        <button class="btn-ghost" type="button" data-close="modal">Cancelar</button>
        <button class="btn btn-accent" id="save-despesas" type="button">Salvar</button>
      </footer>
    </div>
  </div>

  <!-- Modal: Dívidas -->
  <div class="modal" id="modal-dividas" role="dialog" aria-modal="true" aria-labelledby="ttl-dividas">
    <div class="overlay" data-close="modal"></div>
    <div class="dialog">
      <header>
        <h3 id="ttl-dividas">Dívidas</h3>
        <button class="close-x" type="button" data-close="modal" aria-label="Fechar">✕</button>
      </header>
      <div class="content">
        <div id="list-dividas"></div>
        <button class="add-btn" id="add-divida" type="button">+ Adicionar dívida</button>
        <p class="muted" style="margin-top:8px">Informe o término (mês/ano) para calcular as previsões.</p>
      </div>
      <footer>
        <button class="btn-ghost" type="button" data-close="modal">Cancelar</button>
        <button class="btn btn-accent" id="save-dividas" type="button">Salvar</button>
      </footer>
    </div>
  </div>

  <script>
    // ---------------- Utilidades ----------------
    const STORAGE_KEY = 'financeData.v2';
    const money = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const monthFmt = new Intl.DateTimeFormat('pt-BR', { month:'long', year:'numeric' });
    const fmt = v => money.format(isFinite(v)?v:0);
    const textBR = n => (isFinite(n)?Number(n):0).toFixed(2).replace('.',',');

    function uuid(){ return crypto?.randomUUID ? crypto.randomUUID() : ('id-'+Math.random().toString(36).slice(2)+Date.now()); }
    function toNumber(val){
      if (typeof val==='number') return isFinite(val)&&val>=0?val:0;
      if (val==null) return 0;
      let s = String(val).trim(); if(!s) return 0;
      s = s.replace(/\s/g,'').replace(/[R$\u00A0]/gi,'');
      if (s.includes('.') && s.includes(',')) s = s.replace(/\./g,'').replace(/,/g,'.');
      else if (s.includes(',')) s = s.replace(/,/g,'.');
      s = s.replace(/[^\d.-]/g,'');
      const n = parseFloat(s);
      return isFinite(n)&&n>=0?n:0;
    }
    function toInt(val,min=1){ const n=parseInt(val,10); return Number.isFinite(n)&&n>=min?n:min; }

    // Datas (YYYY-MM)
    const ymRe=/^\d{4}-(0[1-9]|1[0-2])$/;
    function nowYM(){ const d=new Date(); return {y:d.getFullYear(), m:d.getMonth()+1}; }
    function ymToIndex(y,m){ return y*12 + (m-1); }
    function indexToYM(i){ const y=Math.floor(i/12), m=(i%12)+1; return {y,m}; }
    function addMonths(y,m,delta){ return indexToYM(ymToIndex(y,m)+delta); }
    function ymStr(y,m){ return `${y}-${String(m).padStart(2,'0')}`; }
    function parseYM(s){ if(!s||!ymRe.test(s)) return null; const [yy,mm]=s.split('-').map(Number); return {y:yy,m:mm}; }

    // ---------------- Estado ----------------
    const defaultState = () => ({ salario:0, descontos:[], despesasFixas:[], dividas:[] });
    let state = loadState();

    function normalizeState(data){
      const s = defaultState();
      if (data && typeof data==='object'){
        s.salario = toNumber(data.salario);
        s.descontos = Array.isArray(data.descontos)? data.descontos.map(x=>({id:x.id||uuid(),nome:(x.nome??'').toString(),valor:toNumber(x.valor)})) : [];
        s.despesasFixas = Array.isArray(data.despesasFixas)? data.despesasFixas.map(x=>({id:x.id||uuid(),nome:(x.nome??'').toString(),valor:toNumber(x.valor)})) : [];
        const {y:cy,m:cm}=nowYM();
        s.dividas = Array.isArray(data.dividas)? data.dividas.map(x=>{
          const parcelas = toInt(x.parcelas,1);
          let fim = (typeof x.fim==='string' && ymRe.test(x.fim)) ? x.fim : null;
          if(!fim){ const end=addMonths(cy,cm,Math.max(0,parcelas-1)); fim=ymStr(end.y,end.m); }
          return { id:x.id||uuid(), nome:(x.nome??'').toString(), valorTotal:toNumber(x.valorTotal), parcelas, fim };
        }) : [];
      }
      return s;
    }
    function loadState(){
      try{
        const raw=localStorage.getItem(STORAGE_KEY);
        if(raw) return normalizeState(JSON.parse(raw));
        const v1=localStorage.getItem('financeData.v1');
        if(v1){ const s=normalizeState(JSON.parse(v1)); localStorage.setItem(STORAGE_KEY,JSON.stringify(s)); return s; }
        return defaultState();
      }catch{ return defaultState(); }
    }
    function saveState(next=state){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(next)); }catch{} }

    // ---------------- Cálculos ----------------
    function sumDescontos(){ return state.descontos.reduce((a,b)=>a+toNumber(b.valor),0); }
    function sumDespesas(){ return state.despesasFixas.reduce((a,b)=>a+toNumber(b.valor),0); }
    function sumDividas(){ return state.dividas.reduce((a,b)=>a+toNumber(b.valorTotal),0); }
    function saldoFinal(){ return toNumber(state.salario) - (sumDescontos() + sumDespesas() + sumDividas()); }

    // Dívida ativa no mês alvo (término incluso)
    function monthInSchedule(d,y,m){
      const end=parseYM(d.fim); if(!end) return false;
      const endIdx=ymToIndex(end.y,end.m);
      const startIdx=endIdx-(toInt(d.parcelas,1)-1);
      const idx=ymToIndex(y,m);
      return idx>=startIdx && idx<=endIdx;
    }
    // Projeção: total das dívidas ativas do mês
    function debtTotalForMonth(y,m){
      return state.dividas.reduce((acc,d)=> acc + (monthInSchedule(d,y,m)? toNumber(d.valorTotal):0), 0);
    }
    function forecastFor(y,m){
      return toNumber(state.salario) - (sumDescontos() + sumDespesas() + debtTotalForMonth(y,m));
    }

    // ---------------- UI ----------------
    function updateCards(){
      document.getElementById('val-salario').textContent = fmt(state.salario);
      document.getElementById('val-descontos').textContent = fmt(sumDescontos());
      document.getElementById('val-despesas').textContent = fmt(sumDespesas());
      document.getElementById('val-dividas').textContent = fmt(sumDividas());
      document.getElementById('saldo-final').textContent = 'Saldo Final: ' + fmt(saldoFinal());
      document.getElementById('kpi-sal').textContent = 'Salário: ' + fmt(state.salario);
      document.getElementById('kpi-desc').textContent = 'Descontos: ' + fmt(sumDescontos());
      document.getElementById('kpi-desp').textContent = 'Despesas: ' + fmt(sumDespesas());
      document.getElementById('kpi-div').textContent = 'Dívidas: ' + fmt(sumDividas());
      updateForecastCards();
    }

    // ---------------- Previsões (12 meses) ----------------
    const FORECAST_MONTHS = 12;
    function buildForecastCards(n=FORECAST_MONTHS){
      const wrap=document.querySelector('.grid.forecast'); wrap.innerHTML='';
      for(let i=1;i<=n;i++){
        wrap.insertAdjacentHTML('beforeend', `
          <article class="card" id="fprev-${i}">
            <div class="card-header">
              <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <circle cx="12" cy="12" r="9" stroke="#8b5cf6" stroke-width="1.5"></circle>
                  <path d="M7 12h10" stroke="#c4b5fd" stroke-width="1.4" stroke-linecap="round"></path>
                </svg>
                <span id="fprev-${i}-label">Mês ${i}</span>
              </div>
            </div>
            <div class="card-value small" id="fprev-${i}-value">R$ 0,00</div>
            <div class="hint">Saldo projetado</div>
          </article>
        `);
      }
    }
    function updateForecastCards(){
      const {y,m}=nowYM();
      for(let i=1;i<=FORECAST_MONTHS;i++){
        const t=addMonths(y,m,i);
        const elLabel=document.getElementById(`fprev-${i}-label`);
        const elValue=document.getElementById(`fprev-${i}-value`);
        if(!elLabel||!elValue) continue;
        elLabel.textContent = monthFmt.format(new Date(t.y,t.m-1,1));
        elValue.textContent = fmt(forecastFor(t.y,t.m));
      }
    }

    // ---------------- Modais ----------------
    function openModal(id){ const el=document.getElementById(id); if(!el) return; el.classList.add('show'); document.body.style.overflow='hidden'; }
    function closeModal(el){ if(!el) return; el.classList.remove('show'); document.body.style.overflow=''; }

    // Fechamento robusto: overlay, [data-close="modal"], tecla Esc
    document.addEventListener('click', (e)=>{
      const overlay = e.target.closest('.overlay');
      const btnClose = e.target.closest('[data-close="modal"]');
      if (overlay){ closeModal(overlay.closest('.modal')); }
      if (btnClose){ closeModal(btnClose.closest('.modal')); }
    });
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape'){ document.querySelectorAll('.modal.show').forEach(m=>closeModal(m)); }
    });

    // ---------------- Builders de linhas ----------------
    function buildRow(container,item,onChange,onRemove){
      const row=document.createElement('div'); row.className='row';
      const nameWrap=document.createElement('div'); const nameLabel=document.createElement('label'); nameLabel.textContent='Nome';
      const name=document.createElement('input'); name.type='text'; name.placeholder='Ex.: INSS, Plano de saúde'; name.value=item.nome??''; name.addEventListener('input',()=>{ item.nome=name.value; onChange&&onChange(); });
      nameWrap.appendChild(nameLabel); nameWrap.appendChild(name);
      const valWrap=document.createElement('div'); const valLabel=document.createElement('label'); valLabel.textContent='Valor (R$)';
      const val=document.createElement('input'); val.type='text'; val.inputMode='decimal'; val.placeholder='0,00'; val.value=textBR(item.valor??0); val.addEventListener('input',()=>{ item.valor=toNumber(val.value); onChange&&onChange(); });
      valWrap.appendChild(valLabel); valWrap.appendChild(val);
      const del=document.createElement('button'); del.className='remove-btn'; del.type='button'; del.title='Remover'; del.textContent='🗑️'; del.addEventListener('click',()=>{ onRemove&&onRemove(item.id); });
      row.appendChild(nameWrap); row.appendChild(valWrap); row.appendChild(del); container.appendChild(row);
    }
    function buildDebtRow(container,item,onChange,onRemove){
      const row=document.createElement('div'); row.className='row debt';
      const nameWrap=document.createElement('div'); const nameLabel=document.createElement('label'); nameLabel.textContent='Nome';
      const name=document.createElement('input'); name.type='text'; name.placeholder='Ex.: Cartão X, Empréstimo Y'; name.value=item.nome??''; name.addEventListener('input',()=>{ item.nome=name.value; onChange&&onChange(); });
      nameWrap.appendChild(nameLabel); nameWrap.appendChild(name);
      const valWrap=document.createElement('div'); const valLabel=document.createElement('label'); valLabel.textContent='Valor total (R$)';
      const val=document.createElement('input'); val.type='text'; val.inputMode='decimal'; val.placeholder='0,00'; val.value=textBR(item.valorTotal??0); val.addEventListener('input',()=>{ item.valorTotal=toNumber(val.value); onChange&&onChange(); });
      valWrap.appendChild(valLabel); valWrap.appendChild(val);
      const parWrap=document.createElement('div'); const parLabel=document.createElement('label'); parLabel.textContent='Parcelas';
      const par=document.createElement('input'); par.type='number'; par.step='1'; par.min='1'; par.inputMode='numeric'; par.value=String(item.parcelas??1); par.addEventListener('input',()=>{ item.parcelas=toInt(par.value,1); onChange&&onChange(); });
      parWrap.appendChild(parLabel); parWrap.appendChild(par);
      const endWrap=document.createElement('div'); const endLabel=document.createElement('label'); endLabel.textContent='Término (mês/ano)';
      const end=document.createElement('input'); end.type='month'; end.value=(typeof item.fim==='string' && ymRe.test(item.fim))?item.fim:''; end.addEventListener('input',()=>{ item.fim=ymRe.test(end.value)?end.value:''; onChange&&onChange(); });
      endWrap.appendChild(endLabel); endWrap.appendChild(end);
      const del=document.createElement('button'); del.className='remove-btn'; del.type='button'; del.title='Remover'; del.textContent='🗑️'; del.addEventListener('click',()=>{ onRemove&&onRemove(item.id); });
      row.appendChild(nameWrap); row.appendChild(valWrap); row.appendChild(parWrap); row.appendChild(endWrap); row.appendChild(del); container.appendChild(row);
    }

    // ---------------- Modais: controladores ----------------
    let tempSalario=0, tempDescontos=[], tempDespesas=[], tempDividas=[];
    function openSalario(){ tempSalario=state.salario; const inp=document.getElementById('inp-salario'); inp.value=textBR(tempSalario); openModal('modal-salario'); setTimeout(()=>inp.focus(),0); }
    function saveSalario(){ const inp=document.getElementById('inp-salario'); state.salario=toNumber(inp.value); saveState(); updateCards(); closeModal(document.getElementById('modal-salario')); }

    function openDescontos(){ tempDescontos=state.descontos.map(x=>({...x})); renderDescontos(); openModal('modal-descontos'); }
    function renderDescontos(){ const wrap=document.getElementById('list-descontos'); wrap.innerHTML=''; if(tempDescontos.length===0){ const p=document.createElement('p'); p.className='muted'; p.textContent='Nenhum desconto adicionado.'; wrap.appendChild(p);} tempDescontos.forEach(it=>buildRow(wrap,it,()=>{}, id=>{tempDescontos=tempDescontos.filter(x=>x.id!==id); renderDescontos();})); }
    function addDesconto(){ tempDescontos.push({id:uuid(),nome:'',valor:0}); renderDescontos(); }
    function saveDescontos(){ state.descontos=tempDescontos.map(x=>({...x,valor:toNumber(x.valor)})).filter(x=>(x.nome?.trim()?.length??0)>0 || x.valor>0); saveState(); updateCards(); closeModal(document.getElementById('modal-descontos')); }

    function openDespesas(){ tempDespesas=state.despesasFixas.map(x=>({...x})); renderDespesas(); openModal('modal-despesas'); }
    function renderDespesas(){ const wrap=document.getElementById('list-despesas'); wrap.innerHTML=''; if(tempDespesas.length===0){ const p=document.createElement('p'); p.className='muted'; p.textContent='Nenhuma despesa fixa adicionada.'; wrap.appendChild(p);} tempDespesas.forEach(it=>buildRow(wrap,it,()=>{}, id=>{tempDespesas=tempDespesas.filter(x=>x.id!==id); renderDespesas();})); }
    function addDespesa(){ tempDespesas.push({id:uuid(),nome:'',valor:0}); renderDespesas(); }
    function saveDespesas(){ state.despesasFixas=tempDespesas.map(x=>({...x,valor:toNumber(x.valor)})).filter(x=>(x.nome?.trim()?.length??0)>0 || x.valor>0); saveState(); updateCards(); closeModal(document.getElementById('modal-despesas')); }

    function openDividas(){ tempDividas=state.dividas.map(x=>({...x})); renderDividas(); openModal('modal-dividas'); }
    function renderDividas(){ const wrap=document.getElementById('list-dividas'); wrap.innerHTML=''; if(tempDividas.length===0){ const p=document.createElement('p'); p.className='muted'; p.textContent='Nenhuma dívida adicionada.'; wrap.appendChild(p);} tempDividas.forEach(it=>buildDebtRow(wrap,it,()=>{}, id=>{tempDividas=tempDividas.filter(x=>x.id!==id); renderDividas();})); }
    function addDivida(){ const {y,m}=nowYM(); tempDividas.push({id:uuid(),nome:'',valorTotal:0,parcelas:1,fim:ymStr(y,m)}); renderDividas(); }
    function ensureDebtEndOrDefault(d){ if(typeof d.fim==='string' && ymRe.test(d.fim)) return d.fim; const now=nowYM(); const end=addMonths(now.y,now.m,Math.max(0,toInt(d.parcelas,1)-1)); return ymStr(end.y,end.m); }
    function saveDividas(){ state.dividas=tempDividas.map(x=>({...x,valorTotal:toNumber(x.valorTotal),parcelas:toInt(x.parcelas,1),fim:ensureDebtEndOrDefault(x)})).filter(x=>(x.nome?.trim()?.length??0)>0 || x.valorTotal>0); saveState(); updateCards(); closeModal(document.getElementById('modal-dividas')); }

    // ---------------- Import/Export ----------------
    function exportJSON(){const pretty=JSON.stringify(state,null,2);const blob=new Blob([pretty],{type:'application/json'});const url=URL.createObjectURL(blob);const d=new Date();const f=`Controle_Export_${String(d.getDate()).padStart(2,'0')}_${String(d.getMonth()+1).padStart(2,'0')}_${d.getFullYear()}_${String(d.getHours()).padStart(2,'0')}_${String(d.getMinutes()).padStart(2,'0')}.json`;const a=document.createElement('a');a.href=url;a.download=f;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}
    function importJSON(file){ if(!file) return; const reader=new FileReader(); reader.onload=()=>{ try{ state=normalizeState(JSON.parse(reader.result)); saveState(); buildForecastCards(FORECAST_MONTHS); updateCards(); document.querySelectorAll('.modal.show').forEach(m=>closeModal(m)); }catch{ alert('Arquivo inválido.'); } }; reader.onerror=()=>alert('Não foi possível ler o arquivo.'); reader.readAsText(file,'utf-8'); }

    // ---------------- Eventos ----------------
    function setupEvents(){
      document.getElementById('card-salario').addEventListener('click',openSalario);
      document.getElementById('card-descontos').addEventListener('click',openDescontos);
      document.getElementById('card-despesas').addEventListener('click',openDespesas);
      document.getElementById('card-dividas').addEventListener('click',openDividas);
      ['card-salario','card-descontos','card-despesas','card-dividas'].forEach(id=>{
        const el=document.getElementById(id);
        el.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); el.click(); }});
      });
      document.getElementById('save-salario').addEventListener('click',saveSalario);
      document.getElementById('add-desconto').addEventListener('click',addDesconto);
      document.getElementById('save-descontos').addEventListener('click',saveDescontos);
      document.getElementById('add-despesa').addEventListener('click',addDespesa);
      document.getElementById('save-despesas').addEventListener('click',saveDespesas);
      document.getElementById('add-divida').addEventListener('click',addDivida);
      document.getElementById('save-dividas').addEventListener('click',saveDividas);
      document.getElementById('btn-export').addEventListener('click',exportJSON);
      const fileInput=document.getElementById('file-input');
      document.getElementById('btn-import').addEventListener('click',()=>fileInput.click());
      fileInput.addEventListener('change',(e)=>importJSON(e.target.files?.[0]));
      window.addEventListener('storage',(e)=>{ if(e.key===STORAGE_KEY){ try{ state=normalizeState(JSON.parse(e.newValue||'{}')); buildForecastCards(FORECAST_MONTHS); updateCards(); }catch{} }});
    }

    // ---------------- Inicialização ----------------
    buildForecastCards(FORECAST_MONTHS);
    updateCards();
    setupEvents();
  </script>
</body>
</html>
